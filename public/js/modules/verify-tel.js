/*! Tomcat360.com (c) 2015 
	Author: Renzhao
*/
define("modules/verify-tel",["form-validator"],function(t,e,r){"use strict";String.prototype.hasOwnProperty("trim")||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});var a=t("form-validator"),i=function(t,e){return this.version="0.0.5",this.params={},this.errorStatus={1:null,2:"该手机已被注册",3:"系统错误",4:"用户不存在",5:"手机与用户不符"},this.box=t||".verifytel-box","string"==typeof this.box&&(this.box=$(this.box).first()),this.box.size()?(this.input=this.box.find("input"),this.btn=this.box.find(".pure-button"),this.btn.prop("disable",!1),this.setConfig(e),this._init()):this};i.prototype={_init:function(){var t=this;return t.btn.prop("disabled",!1),t.btn.click(function(){t.sendCode()}),t},setConfig:function(t){var e=this;return t=t||{},this.params.telphone=t.target||this.box.data("target")||"#telphone",this.params.username=t.username||this.box.data("username")||"#username",this.params.imgCode="#imgCode",this.params.totalTime=t.totalTime||60,this.params.type=t.type||"normal",this.params.url=t.url||"/sendvcode.html",this.params.done=t.done||function(t){var r=e.params.totalTime,a=window.setInterval(function(){if(e.btn.text(r+"秒后可重发"),0>r){window.clearInterval(a),e.btn.text("重新发送"),e.btn.prop("disabled",!1);var t=$("#yzmimg").attr("src").split("?")[0];t+="?"+Math.random(),$("#yzmimg").attr("src",t),$("#imgCode").val("")}--r},1e3)},e},_alert:function(t){var e=this.box.parents(".pure-control-group"),r=e.find(".xlabel");return r.size()&&r.remove(),r=$("<div class='xlabel'></div>"),r.addClass("error").text(t),e.append(r),self},sendCode:function(){this.ajaxReq&&this.ajaxReq.abort();var t=this,e=$(t.params.telphone).val().trim(),r=a.telphone,i=r(e),s=$(t.params.imgCode).val().trim(),n=a.imgCode,o=n(s);if(!i.result)return t._alert(i.msg),t;if(!o.result){var p=$("<div class='xlabel'>请填写正确的验证码</div>");return $("#imgCode").parent().parent().find(".xlabel").remove(),$("#imgCode").parent().parent().append(p),!1}var l={phone:e};"forget"===t.params.type&&(l.cto="hehe",l.forgetname=e),this.ajaxReq=$.ajax({url:ROOT_URL+t.params.url+"?t="+Math.random(),data:l,dataType:"json",success:function(e){var r=e;1===r?(t.btn.prop("disabled",!0),t.params.done(e)):t._alert(t.errorStatus[r])},error:function(){p("短信发送失败，可能是网络原因")}})}},r.exports=i});